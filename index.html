<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Portfolio | Owen Kelley</title>
<link rel="stylesheet" href="styles.css" />
</head>
<body>
<header>
  <nav>
    <ul>
      <li><a href="#/home" data-route="home">Home</a></li>
      <li><a href="#/projects" data-route="projects">Projects</a></li>
    </ul>
  </nav>
</header>

<main>
  <!-- HOME PAGE (intro only) -->
  <div class="page home-page" data-page="home">
    <section id="intro">
      <div class="centered-container">
        <div class="intro-text" id="introText">
          <div class="intro-lines">
            <p class="tagline">Security-minded engineer building clean, fast experiences.</p>
            <div class="intro-line small">
              <span id="hiLine"></span>
              <span class="caret" aria-hidden="true"></span>
            </div>
          
            <div class="intro-line big" id="bigLine">
              <span class="name-spot">
                <span id="nameLine" class="aurora-text"></span>
              </span>
            </div>                     
          </div>
          <div class="cta-row">
            <a class="btn primary" href="#/projects">View Projects</a>
            <a class="btn" href="resume.pdf" target="_blank" rel="noopener">Resume</a>
          </div>

          <div class="social">
            <a href="https://github.com/your-handle">GitHub</a>
            <span aria-hidden="true">·</span>
            <a href="https://www.linkedin.com/in/your-handle/">LinkedIn</a>
          </div>
        </div>
      </div>
      <!-- Visualizer canvas sits behind content -->
      <canvas id="musicViz" aria-hidden="true"></canvas>

      <!-- Audio controls (small chip) -->
      <div class="audio-chip" id="audioChip" hidden>
        <button id="audioToggle" aria-pressed="false" aria-label="Play music">♫ Play</button>
      </div>      

      <!-- Your track (swap src with your file/URL) -->
      <audio id="heroTrack" src="audio/welcome.mp3" preload="auto"></audio>
    </section>
  </div>

  <!-- PROJECTS PAGE (isolated) -->
  <div class="page projects-page" data-page="projects">
    <section id="projects" class="anchor" aria-label="Projects">
      <div class="projects-pin">
        <div class="pinner" id="projectsPinner">
          <div class="section-head">
            <h2 style="margin:0 0 6px 0;">Projects</h2>
            <p style="margin:0;color:var(--muted);font-size:.95rem;">Scroll to step through projects. The page continues after the last one.</p>
          </div>
          <div class="carousel" id="projectsCarousel" aria-live="polite">
            <div class="track" role="group" aria-roledescription="carousel" aria-label="Project slides (vertical)">
              <!-- Slide 1 -->
              <article class="slide" role="group" aria-label="ADFS + Duo MFA Integration">
                <div class="project-card">
                  <div class="project-header">
                    <h3>ADFS + Duo MFA Integration</h3>
                    <p class="project-desc">Deployed a .NET app for Windows endpoints, integrating ADFS with Duo MFA to harden authentication with minimal user friction.</p>
                    <div class="tags"><span class="tag">C#</span><span class="tag">.NET</span><span class="tag">ADFS</span><span class="tag">Duo</span><span class="tag">Security</span></div>
                    <div class="divider"></div>
                    <ul class="bullets">
                      <li>Reduced risky sign-ins by 42% post rollout.</li>
                      <li>Graceful fallbacks for offline devices.</li>
                      <li>Automated installer & health checks.</li>
                    </ul>
                  </div>
                  <div class="project-media"><span>Image / GIF</span></div>
                </div>
              </article>
              <!-- Slide 2 -->
              <article class="slide" role="group" aria-label="Active Directory Auth Gateway">
                <div class="project-card">
                  <div class="project-header">
                    <h3>Active Directory Auth Gateway</h3>
                    <p class="project-desc">Azure gateway VM intercepting Kerberos/NTLM to apply conditional access and 2FA—no agents on domain controllers.</p>
                    <div class="tags"><span class="tag">Azure</span><span class="tag">Networking</span><span class="tag">Kerberos</span><span class="tag">NTLM</span></div>
                    <div class="divider"></div>
                    <ul class="bullets">
                      <li>WFP-based port inspection & policy engine.</li>
                      <li>Per-request Duo prompt with allow/deny.</li>
                      <li>Traffic shaping for lab replay tests.</li>
                    </ul>
                  </div>
                  <div class="project-media"><span>Diagram</span></div>
                </div>
              </article>
              <!-- Slide 3 -->
              <article class="slide" role="group" aria-label="Fitness Tracking App">
                <div class="project-card">
                  <div class="project-header">
                    <h3>Fitness Tracking App</h3>
                    <p class="project-desc">SwiftUI mobile app to create and track workouts, integrating WHOOP data to adjust training intensity dynamically.</p>
                    <div class="tags"><span class="tag">SwiftUI</span><span class="tag">iOS</span><span class="tag">Health APIs</span></div>
                    <div class="divider"></div>
                    <ul class="bullets">
                      <li>Workout builder with sets/reps/weights.</li>
                      <li>Zone-based trends & auto-adjustments.</li>
                      <li>Clean, offline-first local store.</li>
                    </ul>
                  </div>
                  <div class="project-media"><span>App Screens</span></div>
                </div>
              </article>
            </div>
          </div>
        </div>
      </div>
    </section>
  </div>
</main>

<footer>
  <p>&copy; 2025 Owen Kelley</p>
</footer>

<script>
  // ===== Role Typewriter (subtitle) =====
  (function(){
    const hiEl   = document.getElementById('hiLine');
    const nameEl = document.getElementById('nameLine');
    if(!hiEl || !nameEl) return;

    const reduce = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;
    const HI   = "Hi, my name is";
    const NAME = "Owen.";    // keep your period if you want it
    const TYPE = 125;        // slow it down if you like

    function typeTo(el, text, i = 0, done){
      if (reduce) { el.textContent = text; done && done(); return; }
      el.textContent = text.slice(0, i);
      if (i < text.length) setTimeout(() => typeTo(el, text, i + 1, done), TYPE);
      else done && done();
    }

    function startTyping(){
      typeTo(hiEl, HI, 0, () => {
        document.querySelector('.intro-line.small .caret')?.remove();   // remove small caret

        // Slight pause, then set text and fade the big line in
        setTimeout(() => {
          nameEl.textContent = NAME;
          (document.getElementById('bigLine') || document.querySelector('.intro-line.big'))?.classList.add('show');
            // 👉 tell the rest of the page the name is visible
          window.dispatchEvent(new Event('name-shown'));
        }, 300);
      });
    }

    let started = false;
    function kick(){
      if (started) return;
      if ((location.hash || '#/home') === '#/projects') return;
      started = true;
      startTyping();
    }

    // Start ONLY after the overlay reveals
    window.addEventListener('hero-revealed', kick, { once: true });
  })();

  // === Helpers ===
  function getHeaderH(){
    const v = getComputedStyle(document.documentElement).getPropertyValue('--headerH').trim();
    const n = parseFloat(v);
    return isNaN(n) ? 80 : n;
  }
  function smoothScrollTo(y){ window.scrollTo({ top: y, behavior: 'smooth' }); }

  // === Simple hash router (#/home, #/projects) ===
  (function(){
    const pages = {
      home: document.querySelector('.home-page'),
      projects: document.querySelector('.projects-page')
    };
    const navLinks = Array.from(document.querySelectorAll('nav a'));
    let homeSpyObserver = null;
    let projectsInitialized = false;

    function setNavActive(which){
      navLinks.forEach(a => {
        const r = a.getAttribute('data-route');
        a.classList.toggle('active', r === which || (which!== 'projects' && r === 'home' && which === 'home-spy'));
      });
    }

    // Scroll spy for home page (intro only)
    function initHomeSpy(){
      if(homeSpyObserver) homeSpyObserver.disconnect();
      const ids = ['intro'];
      const headerH = getHeaderH();
      homeSpyObserver = new IntersectionObserver((entries)=>{
        entries.forEach(entry => { if(entry.isIntersecting){
          const id = entry.target.id;
          navLinks.forEach(a=>{
            const r = a.getAttribute('data-route');
            const match = (id==='intro' && r==='home');
            a.classList.toggle('active', match);
          });
        }});
      }, { root: null, threshold: 0.55, rootMargin: `-${headerH}px 0px -40% 0px` });
      ids.forEach(id => { const el = document.getElementById(id); if(el) homeSpyObserver.observe(el); });
    }

    function showPage(which){
      pages.home.classList.toggle('active', which !== 'projects');
      pages.projects.classList.toggle('active', which === 'projects');

      if(which === 'projects'){
        if(homeSpyObserver) homeSpyObserver.disconnect();
        setNavActive('projects');
        if(!projectsInitialized){ initProjectsPage(); projectsInitialized = true; }
        sizeProjectsPin();
      } else {
        initHomeSpy();
        smoothScrollTo(0);
      }
    }

    function parseRoute(){
      const hash = location.hash || '#/home';
      const m = hash.match(/^#\/(.*)$/);
      const r = m ? m[1] : 'home';
      if(['home','projects'].includes(r)) return r;
      return 'home';
    }

    window.addEventListener('hashchange', ()=> showPage(parseRoute()));
    document.addEventListener('DOMContentLoaded', ()=> showPage(parseRoute()));
  })();

  // === Projects page logic ===
  function sizeProjectsPin() {
    const pinner = document.getElementById('projectsPinner');
    if(!pinner) return;
    const pinWrap = pinner.parentElement;
    const slides = document.querySelectorAll('#projectsCarousel .slide').length;
    if (!pinWrap || !slides) return;
    const hh = getHeaderH();
    const perSlide = Math.max(1, window.innerHeight - hh);
    pinWrap.style.minHeight = (perSlide * slides + 0.5) + 'px';
  }
  window.addEventListener('resize', sizeProjectsPin);
  document.addEventListener('DOMContentLoaded', sizeProjectsPin);

  function initVerticalCarousel(root){
    const track = root.querySelector('.track');
    const slides = Array.from(root.querySelectorAll('.slide'));
    let index = 0;

    function update(){
      track.style.transform = `translateY(${-index * 100}%)`;
      slides.forEach((s,i)=> s.setAttribute('aria-hidden', i!==index));
    }
    function goTo(i){ index = Math.max(0, Math.min(slides.length-1, i)); update(); }
    function prev(){ goTo(index-1); }
    function next(){ goTo(index+1); }

    let startY = 0, currY = 0, dragging = false;
    const py = (e)=> e.touches? e.touches[0].clientY : e.clientY;
    function onDown(e){ dragging=true; startY=py(e); currY=startY; track.style.transition='none'; }
    function onMove(e){ if(!dragging) return; currY=py(e); const dy=currY-startY; track.style.transform = `translateY(calc(${-index*100}% + ${dy}px))`; }
    function onUp(){ if(!dragging) return; dragging=false; track.style.transition=''; const dy=currY-startY; const threshold=Math.min(140, window.innerHeight*0.18); if(dy>threshold) prev(); else if(dy<-threshold) next(); else update(); }

    track.addEventListener('pointerdown', onDown);
    window.addEventListener('pointermove', onMove);
    window.addEventListener('pointerup', onUp);
    track.addEventListener('touchstart', onDown, {passive:true});
    window.addEventListener('touchmove', onMove, {passive:true});
    window.addEventListener('touchend', onUp);

    window.addEventListener('resize', update);
    update();

    return { getIndex:()=>index, getLast:()=>slides.length-1, goNext:next, goPrev:prev };
  }

  function initProjectsPage(){
    const pinner = document.getElementById('projectsPinner');
    const carousel = document.getElementById('projectsCarousel');
    if(!pinner || !carousel) return;
    pinner.tabIndex = 0;
    const api = initVerticalCarousel(carousel);

    const track = carousel.querySelector('.track');
    let animating = false;
    track.addEventListener('transitionstart', ()=> { animating = true; });
    track.addEventListener('transitionend', ()=> { animating = false; setLocked(false); });

    const body = document.body;
    let wheelCooldown = false;
    let exiting = false;

    function setLocked(locked){ body.classList.toggle('no-scroll', locked); }

    const pinWrap = pinner.parentElement;
    function pinTop(){ return pinWrap.offsetTop; }
    function pinBottom(){ return pinWrap.offsetTop + pinWrap.offsetHeight; }

    const io = new IntersectionObserver((entries)=>{
      if (!entries[0].isIntersecting) { setLocked(false); exiting = false; }
    }, { root: null, threshold: 0 });
    if (pinWrap) io.observe(pinWrap);

    function isPinnedFullscreen(){
      if (exiting) return false;
      const r = pinner.getBoundingClientRect();
      const vh = window.innerHeight;
      const hh = getHeaderH();
      const topAligned = r.top <= (hh + 10);
      const botAligned = r.bottom >= (vh - 10);
      return topAligned && botAligned;
    }

    function snapOut(direction){
      exiting = true;
      setLocked(false);
      const hh = getHeaderH();
      const y = direction === 'down'
        ? (pinBottom() - window.innerHeight + 2)
        : Math.max(0, pinTop() - hh - 2);
      smoothScrollTo(y);
      setTimeout(()=> { exiting = false; }, 400);
    }

    function handleWheel(e){
      if(!document.querySelector('.projects-page').classList.contains('active')) return;
      if(!isPinnedFullscreen()) { setLocked(false); return; }
      if (animating) { e.preventDefault(); return; }
      const atFirst = api.getIndex() === 0;
      const atLast  = api.getIndex() === api.getLast();
      const dy = e.deltaY;

      if ((dy > 0 && !atLast) || (dy < 0 && !atFirst)) {
        e.preventDefault();
        if (wheelCooldown) return;
        wheelCooldown = true;
        setLocked(true);
        dy > 0 ? api.goNext() : api.goPrev();
        setTimeout(()=> wheelCooldown = false, 380);
      } else if (dy > 0 && atLast) {
        e.preventDefault();
        snapOut('down');
      } else if (dy < 0 && atFirst) {
        e.preventDefault();
        snapOut('up');
      }
    }
    pinner.addEventListener('wheel', handleWheel, { passive: false });

    // Touch scroll -> slide (with snapOut at edges)
    let touchStartY = 0, touchCurrY = 0, touching = false;
    function tStart(e){ touching = true; touchStartY = e.touches[0].clientY; touchCurrY = touchStartY; }
    function tMove(e){ if(!touching) return; touchCurrY = e.touches[0].clientY; }
    function tEnd(){
      if(!touching) return; touching = false;
      if(!document.querySelector('.projects-page').classList.contains('active')) return;
      if(!isPinnedFullscreen()) { setLocked(false); return; }
      const dy = touchStartY - touchCurrY;
      const threshold = Math.min(90, window.innerHeight * 0.12);
      const atFirst = api.getIndex() === 0;
      const atLast  = api.getIndex() === api.getLast();
      if (dy > threshold && !atLast) { setLocked(true); api.goNext(); }
      else if (dy < -threshold && !atFirst) { setLocked(true); api.goPrev(); }
      else if (dy > 0 && atLast) { snapOut('down'); }
      else if (dy < 0 && atFirst) { snapOut('up'); }
      else { setLocked(false); }
    }
    pinner.addEventListener('touchstart', tStart, { passive: true });
    pinner.addEventListener('touchmove', tMove, { passive: true });
    pinner.addEventListener('touchend', tEnd);

    // Keyboard support with snapOut
    pinner.addEventListener('keydown', (e)=>{
      if(!document.querySelector('.projects-page').classList.contains('active')) return;
      if(!isPinnedFullscreen()) return;
      const atFirst = api.getIndex() === 0;
      const atLast  = api.getIndex() === api.getLast();
      if(e.key === 'PageDown' || e.key === 'ArrowDown') {
        if(!atLast) { e.preventDefault(); setLocked(true); api.goNext(); }
        else { e.preventDefault(); snapOut('down'); }
      }
      if(e.key === 'PageUp' || e.key === 'ArrowUp') {
        if(!atFirst) { e.preventDefault(); setLocked(true); api.goPrev(); }
        else { e.preventDefault(); snapOut('up'); }
      }
    });
  }
</script>
<script>
  /* Key-only overlay with WELCOME decode -> spin -> wipe */
  (function () {
    // If user deep-links to projects, skip overlay entirely (same behavior you had)
    if ((location.hash || '#/home') === '#/projects') return;
  
    var reduce = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;
  
    // Build overlay DOM (adds the decode text under the square)
    var overlay = document.createElement('div');
    overlay.className = 'intro-overlay';
    overlay.innerHTML =
      '<div class="sq-wrap" tabindex="0" role="button" aria-label="Enter site">' +
        '<div class="square" aria-hidden="true"><span class="keyhole" aria-hidden="true"></span></div>' +
        '<div class="decode-text" id="decodeText" aria-live="polite"></div>' +
      '</div>' +
      '<div class="white-wipe" aria-hidden="true"></div>';
    document.body.appendChild(overlay);
  
    var sq  = overlay.querySelector('.square');
    var kh  = overlay.querySelector('.keyhole');
    var wr  = overlay.querySelector('.sq-wrap');
    var wipe = overlay.querySelector('.white-wipe');
    var decodeEl = overlay.querySelector('#decodeText');

    var introText = document.querySelector('.home-page #intro .intro-text');
  
    function revealPage(){
  overlay.classList.add('revealing');
  const wipe = overlay.querySelector('.white-wipe');

  const finish = () => {
    overlay.classList.add('hidden');
    if (introText) introText.classList.add('show');     // <-- unhide intro block
    window.dispatchEvent(new Event('hero-revealed'));   // <-- kick the typewriter
  };

  if (wipe){
    requestAnimationFrame(()=> { wipe.style.transform = 'translateY(0%)'; });
    wipe.addEventListener('transitionend', finish, { once:true });
  } else {
    finish();
  }
}

  
    // Simple decode animation: WELCOME unscrambles from random chars
    function decodeWelcome(el, word){
      return new Promise(function(resolve){
        var target = (word || 'WELCOME').toUpperCase();
        var len = target.length;
        var chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%&*?';
        function rnd(){ return chars[(Math.random() * chars.length) | 0]; }
  
        var start = null, duration = 900; // ms
        function step(ts){
          if (start == null) start = ts;
          var p = Math.min(1, (ts - start) / duration);
          var revealCount = Math.floor(p * len);
          var out = '';
          for (var i=0; i<len; i++){
            out += (i < revealCount) ? target[i] : rnd();
          }
          el.textContent = out;
          if (p < 1) requestAnimationFrame(step);
          else {
            el.textContent = target;
            resolve();
          }
        }
        // set initial scrambled string so screen readers get something stable
        el.textContent = Array(len).fill('·').join('');
        requestAnimationFrame(step);
      });
    }
  
    let started = false;
    function startSequence(){
      if (started) return;
      started = true;
      window.dispatchEvent(new Event('hero-unlocked'));

      if (reduce){
        decodeEl.textContent = 'WELCOME';
        revealPage();
        return;
      }

      // show the reserved line without causing layout shift
      decodeEl.style.visibility = 'visible';

      decodeWelcome(decodeEl, 'WELCOME').then(function(){
        setTimeout(function(){
          sq.addEventListener('animationend', function(e){
            if (e.animationName === 'spin360'){
              wr.classList.add('lift');
              requestAnimationFrame(revealPage);
            }
          }, { once:true });

          sq.classList.add('spin');
          if (kh) kh.classList.add('spin');
        }, 100);
      });
    }

  
    // interactions
    wr.addEventListener('click', startSequence);
    wr.addEventListener('keydown', function(e){
      if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); startSequence(); }
    });
  
    // if reduced motion is set at load, just show page
    if (reduce) {
      decodeEl.textContent = 'WELCOME';
      revealPage();
    }
  })();
  </script>   
  <script>
    (function setupMusic(){
      const audio  = document.getElementById('heroTrack');
      const canvas = document.getElementById('musicViz');
      const chip   = document.getElementById('audioChip');
      const toggle = document.getElementById('audioToggle');
      if (!audio || !canvas || !chip || !toggle) return;
    
      /* ===== UI timing ===== */
      chip.hidden = true;                                      // hide on lock
      window.addEventListener('hero-revealed', () => { chip.hidden = false; }, { once:true });
      window.addEventListener('hero-unlocked', () => { play().catch(()=>{}); }, { once:true }); // start on key
    
      /* ===== Look & feel ===== */
      const POINTS    = 900;    // more points = smoother line
      const RADIUS_FR = 0.28;   // base radius (fraction of min viewport)
      const AMP_FR    = 0.11;   // waveform displacement amount
      const SMOOTH    = 0.94;   // per-point EMA (0..1) — higher = smoother
      const POST_BLUR_PASSES = 2; // simple neighbor blur passes for extra silk
    
      const LINE_OPACITY = 0.9;
      const LINE_THICK   = 4.5; // base thickness (px), scales with DPR
      const LINE_GLOW    = 16;  // base glow
    
      // Aura: extra, fainter rings that expand slightly with bass
      const AURA_LAYERS  = 4;
      const AURA_GAP_FR  = 0.018; // spacing between layers (fraction of min viewport)
      const AURA_FADE    = 0.58;  // alpha falloff per layer (0..1)
      const BASE_RING_OP = 0.22;  // faint static ring under everything
    
      // Bass influence (tasteful, no “shooting”)
      const BASS_SMOOTH  = 0.9;   // smoothing for bass envelope
      const BASS_TO_GLOW = 10;    // adds to glow on peaks
      const BASS_TO_GAP  = 0.5;   // scales aura spacing on peaks
      const BASS_TO_AMP  = 0.08;  // scales waveform amplitude on peaks
    
      /* ===== Canvas ===== */
      const ctx = canvas.getContext('2d');
      let w=0, h=0, dpr=1, cx=0, cy=0;
    
      function updateCenter(){
        const t = document.querySelector('#bigLine .name-spot') || document.getElementById('bigLine') || document.body;
        const r = t.getBoundingClientRect();
        cx = Math.round((r.left + r.width/2) * dpr);
        cy = Math.round((r.top  + r.height/2) * dpr);
      }
      function resize(){
        dpr = Math.min(2, window.devicePixelRatio || 1);
        w = canvas.width  = Math.floor(innerWidth  * dpr);
        h = canvas.height = Math.floor(innerHeight * dpr);
        canvas.style.width  = innerWidth + 'px';
        canvas.style.height = innerHeight + 'px';
        updateCenter();
      }
      window.addEventListener('resize', resize);
      window.addEventListener('hero-revealed', updateCenter);
      window.addEventListener('name-shown', updateCenter, { once:true });
      resize();
    
      /* ===== Audio ===== */
      let ac=null, analyser=null, timeData=null, freqData=null;
      function ensureAudio(){
        if (ac) return;
        ac = new (window.AudioContext || window.webkitAudioContext)();
        const src  = ac.createMediaElementSource(audio);
        const gain = ac.createGain(); gain.gain.value = 0.7;
        analyser   = ac.createAnalyser();
        analyser.fftSize = 2048; // high time resolution
        timeData   = new Uint8Array(analyser.fftSize);
        freqData   = new Uint8Array(analyser.frequencyBinCount);
        src.connect(gain); gain.connect(analyser); analyser.connect(ac.destination);
      }
    
      function getBass(){
        // 20–160 Hz average
        analyser.getByteFrequencyData(freqData);
        const ny = ac.sampleRate / 2;
        const lo = 20, hi = 160;
        const li = Math.max(0, Math.floor(lo / ny * freqData.length));
        const hiI= Math.min(freqData.length-1, Math.floor(hi / ny * freqData.length));
        let sum=0, n=0;
        for(let i=li;i<=hiI;i++){ sum += freqData[i]; n++; }
        return (sum / Math.max(1,n)) / 255; // 0..1
      }
    
      /* ===== Wave buffers ===== */
      const wave = new Float32Array(POINTS).fill(0);
      const work = new Float32Array(POINTS).fill(0); // temp for blur
    
      function blurOnce(src, dst){
        // simple 1D circular box blur radius=1
        const N = src.length;
        for (let i=0;i<N;i++){
          const p = (i-1+N)%N, n = (i+1)%N;
          dst[i] = (src[p] + src[i] + src[n]) / 3;
        }
      }
    
      function drawWaveAtRadius(baseR, amp, alpha, width, glowBoost){
        // base ring
        ctx.beginPath();
        ctx.arc(cx, cy, baseR, 0, Math.PI*2);
        ctx.lineWidth  = 1.2 * dpr;
        ctx.strokeStyle = `rgba(34,211,238,${BASE_RING_OP})`;
        ctx.stroke();
    
        // build path
        ctx.beginPath();
        for (let i=0;i<=POINTS;i++){
          const j = i % POINTS;
          const a = (j/POINTS) * Math.PI * 2;
          const r = baseR + wave[j] * amp;
          const x = cx + Math.cos(a)*r;
          const y = cy + Math.sin(a)*r;
          if (i === 0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
        }
        ctx.closePath();
    
        ctx.lineJoin = 'round';
        ctx.lineCap  = 'round';
        ctx.globalAlpha = alpha;
        ctx.lineWidth   = width * dpr;
        ctx.shadowColor = 'rgba(34,211,238,0.35)';
        ctx.shadowBlur  = (LINE_GLOW + glowBoost) * dpr;
        ctx.strokeStyle = '#22d3ee';
        ctx.stroke();
        ctx.globalAlpha = 1;
        ctx.shadowBlur  = 0;
      }
    
      /* ===== Loop & controls ===== */
      let running=false, rafId=0, bassSmooth=0;
    
      function frame(){
        rafId = requestAnimationFrame(frame);
        ctx.clearRect(0,0,w,h);
        if (!running || !analyser) return;
    
        // read audio
        analyser.getByteTimeDomainData(timeData);
        const step = timeData.length / POINTS;
    
        // per-point EMA smoothing of waveform
        for (let i=0;i<POINTS;i++){
          const raw = (timeData[Math.floor(i*step)] - 128) / 128; // -1..1
          wave[i] = wave[i]*SMOOTH + raw*(1-SMOOTH);
        }
    
        // extra silk: a couple of cheap neighbor blurs
        for(let p=0;p<POST_BLUR_PASSES;p++){
          blurOnce(wave, work);
          blurOnce(work, wave);
        }
    
        // bass envelope
        const b = getBass();
        bassSmooth = bassSmooth*BASS_SMOOTH + b*(1-BASS_SMOOTH);
    
        const minwh = Math.min(w,h);
        const baseR = minwh * RADIUS_FR;
        const amp   = minwh * (AMP_FR * (1 + bassSmooth * BASS_TO_AMP));
        const glow  = bassSmooth * BASS_TO_GLOW;
        const gap   = minwh * (AURA_GAP_FR * (1 + bassSmooth * BASS_TO_GAP));
    
        // main line
        drawWaveAtRadius(baseR, amp, LINE_OPACITY, LINE_THICK, glow);
    
        // aura layers (fainter, slightly offset)
        for (let i=1;i<=AURA_LAYERS;i++){
          const aAlpha = LINE_OPACITY * Math.pow(AURA_FADE, i);
          const aWidth = Math.max(1.5, LINE_THICK - i*0.9);
          drawWaveAtRadius(baseR + gap*i, amp*0.92, aAlpha, aWidth, glow*0.8);
        }
      }
    
      async function play(){
        ensureAudio();
        if (ac.state === 'suspended') await ac.resume();
        await audio.play();
        running = true;
        toggle.setAttribute('aria-pressed','true');
        toggle.textContent = '♫ Pause';
        if (!rafId) rafId = requestAnimationFrame(frame);
      }
      function pause(){
        running = false;
        toggle.setAttribute('aria-pressed','false');
        toggle.textContent = '♫ Play';
        audio.pause();
      }
      toggle.addEventListener('click', () =>
        toggle.getAttribute('aria-pressed') === 'true' ? pause() : play()
      );
    })();
    </script>    
  </body>
</html>
